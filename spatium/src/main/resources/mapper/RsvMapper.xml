<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.urban.spatium.mapper.RsvMapper">
	
	<delete id="cancelRsvDetail" parameterType="int">
		DELETE
		FROM tbRsvDetail
		WHERE 
		<foreach item="rsvDList" index="index" collection="rsvDetailList" open="(" separator=" or " close=")">
		rsvDetailCode = #{rsvDList}
	  	</foreach>
	</delete>
	
	<delete id="cancelRsv" parameterType="int">
		DELETE
		FROM tbRsv
		WHERE rsvCode = #{rsvCode}
	</delete>
	
	<delete id="cancelRsvRelation" parameterType="int">
		DELETE
		FROM tbRsvRelation
		WHERE rsvRelationRsvCode = #{rsvCode}
	</delete>
	
	<select id="getRsvDetailCodeByRsvCode" parameterType="int" resultType="String">
		SELECT rsvRelationRsvDetailCode
		FROM tbRsvRelation
		WHERE rsvRelationRsvCode = #{rsvCode}
	</select>
	
	<select id="getExItemRsv" parameterType="Rsv" resultType="Rsv">
		<![CDATA[
		SELECT sum(rsvDetailNum) as rsvDetailNum
			, itemCode, rsvStartDateTime
			, rsvEndDateTime 
		FROM
				(SELECT  
				  sum(rsvDetailNum) as rsvDetailNum
				, itemCode, rsvStartDateTime
				, rsvEndDateTime 
			FROM 
				viewRsv
			GROUP by
				itemCode, rsvStartDateTime, rsvEndDateTime 
			having 
				rsvEndDateTime > #{rsvStartDateTime} 
				AND
				rsvStartDateTime < #{rsvEndDateTime} ) as t
		GROUP BY 
			itemCode
		HAVING 
			itemCode
		ORDER BY 
			itemCode;
		]]>
	</select>
		
	<select id="getExRsv" parameterType="Rsv" resultType="Rsv">
		SELECT rsvCode, rsvDetailCode, okaySpaceName, itemTotalName, rsvStartDateTime, rsvEndDateTime
		FROM viewRsv
		WHERE 1=0
		<foreach item="s" index="index" collection="spaceList" open="or (" separator=" or " close=")">
        okaySpaceCode = #{s.spaceCode}
	  	</foreach>
		and
        date(rsvStartDateTime) = #{rsvDate}
	</select>	
	
	<update id="updateRsvPrice">
		UPDATE tbRsv
		SET
			rsvTotalPrice=#{totalPrice}
		WHERE 
			rsvCode=#{rsvCode}
	</update>
	
	<insert id="insertTbRsvRelation">	
		INSERT INTO tbRsvRelation
			(rsvRelationRsvCode
			, rsvRelationRsvDetailCode)
		VALUES 
			( #{rsvCode}
			, #{itemRsvCode})
	</insert>
	
	
	<insert id="insertRsvItemDetail" parameterType="Map" useGeneratedKeys="true" keyProperty="rsvDetailCode">	
		INSERT INTO tbRsvDetail
			(rsvDetailItem
			, rsvDetailNum
			, rsvDetailOnePrice
			, rsvDetailTotalPrice)
		VALUES 
			(#{itemCode}
			, #{itemCount}
			, #{itemRentalPrice}
			, #{itemTotalPrice})
	</insert>
		
	<insert id="insertRsvSpaceDetail" parameterType="Map" useGeneratedKeys="true" keyProperty="rsvDetailCode">
		INSERT INTO tbRsvDetail
			(rsvDetailSpace
			, rsvDetailOnePrice
			, rsvDetailTotalPrice)
		VALUES 
			(#{spaceCode}
			, #{spaceRentalPrice}
			, #{spaceRentalPrice})
	</insert>	
		
	<select id="getItemByCode" parameterType="int" resultType="Item">
		SELECT 
			  itemCode
			, storeTotalCode
			, itemTotalName
			, itemTotalAmount
			, itemRentalPrice
			, itemImg
			, itemRegDate
			, itemChangeRegDate
			, itemTotalUserId
		FROM 
			tbItemTotalAmount
		WHERE
			itemCode = #{tbRecord}
	</select>
		
	<select id="getSpaceByCode" parameterType="int" resultType="OKSpace">
		SELECT 
			okaySpaceCode
			, okayStoreCode
			, okaySpaceName
			, okaySpaceType
			, okayPeopleNumber
			, okayDetailSpace
			, okayBriefSpace
			, okaySpaceTag
			, okaySpaceRentalPrice
			, okayStartTime
			, okayCloseTime
			, okayExceptionStartDate
			, okayExceptionEndDate
			, okayCompletedDate
			, okaySpaceBasicOption
			, okaySpaceId
			, okayRefundPolicyCode
		FROM 
			tbOkaySpace
		WHERE
			okaySpaceCode = #{tbRecord}
	</select>
	
	<select id="getItemByStore" parameterType="int" resultType="Item">
		SELECT 
			  itemCode
			, storeTotalCode
			, itemTotalName
			, itemTotalAmount
			, itemRentalPrice
			, itemImg
			, itemRegDate
			, itemChangeRegDate
			, itemTotalUserId
		FROM 
			tbItemTotalAmount
		WHERE 
			storeTotalCode = #{storeCode}
		
	</select>
		
	<select id="getSpaceByStore" parameterType="int" resultType="OKSpace">
		SELECT 
			  okaySpaceCode
			, okayStoreCode
			, okaySpaceName
			, okaySpaceType
			, okayPeopleNumber
			, okayDetailSpace
			, okayBriefSpace
			, okaySpaceTag
			, okaySpaceRentalPrice
			, okayStartTime
			, okayCloseTime
			, okayExceptionStartDate
			, okayExceptionEndDate
			, okayCompletedDate
			, okaySpaceBasicOption
			, okaySpaceId
			, spaceCateName
		FROM 
			tbOkaySpace AS s
		INNER JOIN
			tbSpaceCate AS c
		ON
			s.okaySpaceType = c.spaceCateCode
		WHERE
			okayStoreCode = #{storeCode}
	</select>
	
	<select id="rsvDetailList" resultType="Rsv">
		SELECT 
			rsvCode
			, rsvDetailNum
			, rsvDetailOnePrice
			, rsvDetailTotalPrice
			, okaySpaceName
			, itemTotalName
			, rsvUserName
			, rsvTime
			, rsvTimePrice
			, rsvDetailCode
			, rsvStartDateTime
			, rsvEndDateTime
		FROM 
			viewRsv
		ORDER BY
			rsvCode DESC
	</select>
		
	<select id="rsvListExtend" resultType="Rsv">
		SELECT 
			rsvDetailCode
			, rsvDetailNum
			, rsvDetailOnePrice
			, rsvDetailTotalPrice
			, okaySpaceName
			, itemTotalName
			, rsvTime
			, rsvUserName
			, rsvTimePrice
			, rsvDetailCode
		FROM 
			viewRsv
		WHERE 
			rsvCode = #{rsvCode};
	</select>	
		
	<select id="rsvList" resultType="Rsv">
		SELECT 
			  rsvCode
			, rsvUserId
			, rsvUserName
			, rsvUserPhone
			, rsvUserEmail
			, rsvUserRequest
			, rsvTotalPrice
			, rsvStartDateTime
			, rsvEndDateTime
			, rsvRegDate
			, rsvState
		FROM 
			tbRsv
		ORDER BY
			rsvCode DESC
	</select>
	
	<insert id="insertTbRsv" parameterType="Rsv" useGeneratedKeys="true" keyProperty="rsvCode">
		INSERT INTO tbRsv(
			  rsvUserId
			, rsvUserName
			, rsvUserPhone
			, rsvUserEmail
			, rsvUserRequest
			, rsvTotalPrice
			, rsvStartDateTime
			, rsvEndDateTime
			, rsvRegDate
			, rsvStoreCode
		)VALUES(
			  #{rsvUserId}
			, #{rsvUserName}
			, #{rsvUserPhone}
			, #{rsvUserEmail}
			, #{rsvUserRequest}
			, #{rsvTotalPrice}
			, #{rsvStartDateTime}
			, #{rsvEndDateTime}
			, NOW()
			, #{rsvStoreCode}
		);
	</insert>
	
	
</mapper>